<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ChaskiTrufi-Conductor</title>
    <link rel="icon" href="imagenes/CHASKITRUFIlog2.png">
    <!-- Hoja de estilos de Leaflet para el mapa -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Librer√≠a JavaScript de Leaflet para mapas -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- SweetAlert2 CDN -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="conductor.css">

</head>
<body>
    <div id="inicio">
        <img src="imagenes/CHASKITRUFI-logo1.png" alt="">
        <h2>CONDUCTOR</h2>
    </div>
    <!-- Contenedor para mostrar informaci√≥n del conductor -->
    <div id="info"></div>

    <div id="panel">
        <h3>Est√°s compartiendo ubicaci√≥n...</h3>
        <div id="map" style="height: 400px;"></div>
    </div>

    <script type="module">
        // Importar m√≥dulos necesarios de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        // Configuraci√≥n de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDe0SAUeg_DOhC2D1fIq2-ZZUhh4_yCSvk",
            authDomain: "chaskitrufi-72d1c.firebaseapp.com",
            databaseURL: "https://chaskitrufi-72d1c-default-rtdb.firebaseio.com",
            projectId: "chaskitrufi-72d1c",
            storageBucket: "chaskitrufi-72d1c.appspot.com",
            messagingSenderId: "997912993962",
            appId: "1:997912993962:web:4937dcf165fcc35306f0d3"
        };
        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        // Obtener datos del conductor desde el localStorage
        const conductor = JSON.parse(localStorage.getItem('conductorActual'));
        // Si no hay datos, redirige al login
        if (!conductor) {
            Swal.fire({
                icon: 'error',
                title: '¬°Error!',
                text: 'Datos del conductor no encontrados. Inicie sesi√≥n correctamente.',
                confirmButtonText: 'Aceptar'
            }).then(() => {
                window.location.href = 'index.html';
            });
            
        }
        // Mostrar nombre y l√≠nea del conductor en la p√°gina
        document.getElementById('info').innerHTML = `
            <p><strong>Nombre:</strong> ${conductor.nombre} ${conductor.apellido}<br>
            <strong>L√≠nea:</strong> ${conductor.nombre_linea}</p>
        `;
        // Inicializar el mapa en Cochabamba (coordenadas aproximadas)
        let map = L.map('map').setView([-17.3926, -66.1569], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
       // Definir icono personalizado para el trufi 
        const iconoAuto = L.icon({
            iconUrl: 'imagenes/auto.png',
            iconSize: [40, 40],
            iconAnchor: [20, 40],
            popupAnchor: [0, -40]
        });
        // Variables para el marcador, ubicaci√≥n anterior y velocidad
        let trufiMarker = null;
        let lastLocation = null;  // Para almacenar la √∫ltima ubicaci√≥n
        let lastTimestamp = null; // Para almacenar el √∫ltimo timestamp
        let ultimaVelocidad = null; // Nueva variable para mostrar en el mapa

  // Funci√≥n para calcular la distancia entre dos puntos (f√≥rmula Haversine)
    function calcularDistancia(lat1, lon1, lat2, lon2) {
        const R = 6371; // Radio de la Tierra en km
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLon = (lon2 - lon1) * (Math.PI / 180);
        const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                  Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                  Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        const distancia = R * c; // Distancia en kil√≥metros
        return distancia;
    }

   // Funci√≥n para calcular velocidad: distancia/tiempo (convertido a horas)
    function calcularVelocidad(distancia, tiempo) {
        const velocidad = distancia / (tiempo / 3600); // Velocidad en km/h
        return velocidad;
    }

    // üîÑ Funci√≥n para mover el marcador suavemente
    function animarMovimiento(marker, nuevaLatLng, duracion = 1000) {
        const inicio = performance.now();
        const inicioLatLng = marker.getLatLng();
        const deltaLat = nuevaLatLng.lat - inicioLatLng.lat;
        const deltaLng = nuevaLatLng.lng - inicioLatLng.lng;

        function animar(timestamp) {
            const progreso = Math.min((timestamp - inicio) / duracion, 1);
            const lat = inicioLatLng.lat + deltaLat * progreso;
            const lng = inicioLatLng.lng + deltaLng * progreso;
            marker.setLatLng([lat, lng]);
            if (progreso < 1) requestAnimationFrame(animar);
        }

        requestAnimationFrame(animar);
    }

    // Funci√≥n que se ejecuta cuando se actualiza la posici√≥n del GPS
    function actualizarUbicacion(position) {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const timestamp = Date.now(); // Milisegundos desde 1970

        const linea = conductor.nombre_linea;
        const id = `${conductor.nombre}_${linea}`;
        const nuevaUbicacion = { lat: lat, lng: lng };
        const MIN_DISTANCIA_KM = 0.005; // 5 metros

        // Si ya tenemos una ubicaci√≥n anterior, calculamos la velocidad
        if (lastLocation && lastTimestamp) {
            const distancia = calcularDistancia(lastLocation.lat, lastLocation.lng, lat, lng);
            const tiempo = (timestamp - lastTimestamp) / 1000; // Tiempo en segundos
            if (distancia < MIN_DISTANCIA_KM) {
                console.log(`No se actualiza: distancia m√≠nima no superada (${distancia.toFixed(4)} km)`);
                return; // No actualiza si no se ha movido lo suficiente
            }
    
            const velocidad = calcularVelocidad(distancia, tiempo);
            ultimaVelocidad = velocidad;
            // Guardar ubicaci√≥n y velocidad en Firebase
            const data = { lat: lat,lng: lng,timestamp: timestamp,velocidad: velocidad };// Guardamos la velocidad 

            set(ref(db, 'ubicaciones_conductores/' + linea + '/' + id), data)
                .then(() => console.log('Ubicaci√≥n y velocidad guardadas'))
                .catch((error) => console.error('Error al guardar ubicaci√≥n y velocidad:', error));
        } else {
            // Si no tenemos una ubicaci√≥n anterior, solo guardamos la ubicaci√≥n
            const data = { lat: lat, lng: lng, timestamp: timestamp};

            set(ref(db, 'ubicaciones_conductores/' + linea + '/' + id), data)
                .then(() => console.log('Ubicaci√≥n guardada'))
                .catch((error) => console.error('Error al guardar ubicaci√≥n:', error));
        }
        // Actualizar √∫ltimas coordenadas y tiempo
        lastLocation = { lat: lat, lng: lng }; // Guardamos la ubicaci√≥n actual como la √∫ltima
        lastTimestamp = timestamp; // Guardamos el timestamp actual como el √∫ltimo
        // Mostrar velocidad en popup del mapa
        const popupTexto = ultimaVelocidad
        ? `Velocidad: ${ultimaVelocidad.toFixed(2)} km/h`
        : 'Obteniendo velocidad...';
    
    if (trufiMarker) {
        animarMovimiento(trufiMarker, { lat, lng }); // ‚úÖ Movimiento suave
        trufiMarker.setPopupContent(popupTexto).openPopup();
    } else {
        trufiMarker = L.marker([lat, lng], { icon: iconoAuto })
            .addTo(map)
            .bindPopup(popupTexto)
            .openPopup();
    }
    map.panTo([lat, lng], { animate: true, duration: 1 }); // ‚úÖ Mapa se mueve suavemente
    }

    let watchId = null;
    // Activar geolocalizaci√≥n en tiempo real
    function iniciarActualizacionConWatch() {
        if (navigator.geolocation) {
            if (watchId !== null) return; // Ya est√° activo
            watchId = navigator.geolocation.watchPosition(
                actualizarUbicacion,
                error => console.error('Error al obtener ubicaci√≥n:', error),
                { enableHighAccuracy: true, maximumAge: 0, timeout: 5000 }
            );
        } else {
            Swal.fire({
                icon: 'warning',
                title: 'Geolocalizaci√≥n no disponible',
                text: 'Este navegador no soporta geolocalizaci√≥n.',
                confirmButtonText: 'OK'
            });
            
        }
    }
    
    // Funci√≥n opcional para detener el seguimiento si en alg√∫n momento deseas hacerlo
    function detenerActualizacion() {
        if (watchId !== null) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
    }
    // Iniciar seguimiento de ubicaci√≥n al cargar la p√°gina
    iniciarActualizacionConWatch();

    </script>
</body>
</html>
